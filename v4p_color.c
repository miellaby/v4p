/**
 * V4P 256-Color Library - Shared Color Palette Implementation
 * 
 * Standardized 256-color palette shared between all V4P backends. The palette is inspired by old Palm
 * Computing Devices and provides a consistent color reference.
 */

// Include v4p_ll.h for type definitions (provided by build system)
#include "v4p_ll.h"
#include "v4p_color.h"

/**
 * Standardized 256-color palette
 * Format: [256][3] where each entry contains {R, G, B} values
 *   // 0..215 combination of
 *   //    ff  cc  99  66  33  00
 *   // B : 0   6  12 108 114 120
 *   // R : 0  18  36  54  72  90
 *   // G : 0   1   2   3  4    5
 *   // e.g  12+54+5 = $99 B + $66 R +$0 G
 *   // 216..224 = GRAY 22 44 55 77 88 aa bb dd
 *   // 225..230 = specials: SILVER, GRAY, MAROON, PURPLE, GREEN, TEAL
 *  // 231..255 = unused (BLACK)
 */
const UInt8 v4p_palette[256][3] = {
    { 255, 255, 255 }, { 255, 204, 255 }, { 255, 153, 255 }, { 255, 102, 255 },
    { 255, 51, 255 },  { 255, 0, 255 },   { 255, 255, 204 }, { 255, 204, 204 },
    { 255, 153, 204 }, { 255, 102, 204 }, { 255, 51, 204 },  { 255, 0, 204 },
    { 255, 255, 153 }, { 255, 204, 153 }, { 255, 153, 153 }, { 255, 102, 153 },
    { 255, 51, 153 },  { 255, 0, 153 },   { 204, 255, 255 }, { 204, 204, 255 },
    { 204, 153, 255 }, { 204, 102, 255 }, { 204, 51, 255 },  { 204, 0, 255 },
    { 204, 255, 204 }, { 204, 204, 204 }, { 204, 153, 204 }, { 204, 102, 204 },
    { 204, 51, 204 },  { 204, 0, 204 },   { 204, 255, 153 }, { 204, 204, 153 },
    { 204, 153, 153 }, { 204, 102, 153 }, { 204, 51, 153 },  { 204, 0, 153 },
    { 153, 255, 255 }, { 153, 204, 255 }, { 153, 153, 255 }, { 153, 102, 255 },
    { 153, 51, 255 },  { 153, 0, 255 },   { 153, 255, 204 }, { 153, 204, 204 },
    { 153, 153, 204 }, { 153, 102, 204 }, { 153, 51, 204 },  { 153, 0, 204 },
    { 153, 255, 153 }, { 153, 204, 153 }, { 153, 153, 153 }, { 153, 102, 153 },
    { 153, 51, 153 },  { 153, 0, 153 },   { 102, 255, 255 }, { 102, 204, 255 },
    { 102, 153, 255 }, { 102, 102, 255 }, { 102, 51, 255 },  { 102, 0, 255 },
    { 102, 255, 204 }, { 102, 204, 204 }, { 102, 153, 204 }, { 102, 102, 204 },
    { 102, 51, 204 },  { 102, 0, 204 },   { 102, 255, 153 }, { 102, 204, 153 },
    { 102, 153, 153 }, { 102, 102, 153 }, { 102, 51, 153 },  { 102, 0, 153 },
    { 51, 255, 255 },  { 51, 204, 255 },  { 51, 153, 255 },  { 51, 102, 255 },
    { 51, 51, 255 },   { 51, 0, 255 },    { 51, 255, 204 },  { 51, 204, 204 },
    { 51, 153, 204 },  { 51, 102, 204 },  { 51, 51, 204 },   { 51, 0, 204 },
    { 51, 255, 153 },  { 51, 204, 153 },  { 51, 153, 153 },  { 51, 102, 153 },
    { 51, 51, 153 },   { 51, 0, 153 },    { 0, 255, 255 },   { 0, 204, 255 },
    { 0, 153, 255 },   { 0, 102, 255 },   { 0, 51, 255 },    { 0, 0, 255 },
    { 0, 255, 204 },   { 0, 204, 204 },   { 0, 153, 204 },   { 0, 102, 204 },
    { 0, 51, 204 },    { 0, 0, 204 },     { 0, 255, 153 },   { 0, 204, 153 },
    { 0, 153, 153 },   { 0, 102, 153 },   { 0, 51, 153 },    { 0, 0, 153 },
    { 255, 255, 102 }, { 255, 204, 102 }, { 255, 153, 102 }, { 255, 102, 102 },
    { 255, 51, 102 },  { 255, 0, 102 },   { 255, 255, 51 },  { 255, 204, 51 },
    { 255, 153, 51 },  { 255, 102, 51 },  { 255, 51, 51 },   { 255, 0, 51 },
    { 255, 255, 0 },   { 255, 204, 0 },   { 255, 153, 0 },   { 255, 102, 0 },
    { 255, 51, 0 },    { 255, 0, 0 },     { 204, 255, 102 }, { 204, 204, 102 },
    { 204, 153, 102 }, { 204, 102, 102 }, { 204, 51, 102 },  { 204, 0, 102 },
    { 204, 255, 51 },  { 204, 204, 51 },  { 204, 153, 51 },  { 204, 102, 51 },
    { 204, 51, 51 },   { 204, 0, 51 },    { 204, 255, 0 },   { 204, 204, 0 },
    { 204, 153, 0 },   { 204, 102, 0 },   { 204, 51, 0 },    { 204, 0, 0 },
    { 153, 255, 102 }, { 153, 204, 102 }, { 153, 153, 102 }, { 153, 102, 102 },
    { 153, 51, 102 },  { 153, 0, 102 },   { 153, 255, 51 },  { 153, 204, 51 },
    { 153, 153, 51 },  { 153, 102, 51 },  { 153, 51, 51 },   { 153, 0, 51 },
    { 153, 255, 0 },   { 153, 204, 0 },   { 153, 153, 0 },   { 153, 102, 0 },
    { 153, 51, 0 },    { 153, 0, 0 },     { 102, 255, 102 }, { 102, 204, 102 },
    { 102, 153, 102 }, { 102, 102, 102 }, { 102, 51, 102 },  { 102, 0, 102 },
    { 102, 255, 51 },  { 102, 204, 51 },  { 102, 153, 51 },  { 102, 102, 51 },
    { 102, 51, 51 },   { 102, 0, 51 },    { 102, 255, 0 },   { 102, 204, 0 },
    { 102, 153, 0 },   { 102, 102, 0 },   { 102, 51, 0 },    { 102, 0, 0 },
    { 51, 255, 102 },  { 51, 204, 102 },  { 51, 153, 102 },  { 51, 102, 102 },
    { 51, 51, 102 },   { 51, 0, 102 },    { 51, 255, 51 },   { 51, 204, 51 },
    { 51, 153, 51 },   { 51, 102, 51 },   { 51, 51, 51 },    { 51, 0, 51 },
    { 51, 255, 0 },    { 51, 204, 0 },    { 51, 153, 0 },    { 51, 102, 0 },
    { 51, 51, 0 },     { 51, 0, 0 },      { 0, 255, 102 },   { 0, 204, 102 },
    { 0, 153, 102 },   { 0, 102, 102 },   { 0, 51, 102 },    { 0, 0, 102 },
    { 0, 255, 51 },    { 0, 204, 51 },    { 0, 153, 51 },    { 0, 102, 51 },
    { 0, 51, 51 },     { 0, 0, 51 },      { 0, 255, 0 },     { 0, 204, 0 },
    { 0, 153, 0 },     { 0, 102, 0 },     { 0, 51, 0 },      { 17, 17, 17 },
    { 34, 34, 34 },    { 68, 68, 68 },    { 85, 85, 85 },    { 119, 119, 119 },
    { 136, 136, 136 }, { 170, 170, 170 }, { 187, 187, 187 }, { 221, 221, 221 },
    { 238, 238, 238 }, { 192, 192, 192 }, { 128, 128, 128 }, { 128, 0, 0 },
    { 128, 0, 128 },   { 0, 128, 0 },     { 0, 128, 128 },   { 0, 0, 0 },
    { 0, 0, 0 },       { 0, 0, 0 },       { 0, 0, 0 },       { 0, 0, 0 },
    { 0, 0, 0 },       { 0, 0, 0 },       { 0, 0, 0 },       { 0, 0, 0 },
    { 0, 0, 0 },       { 0, 0, 0 },       { 0, 0, 0 },       { 0, 0, 0 },
    { 0, 0, 0 },       { 0, 0, 0 },       { 0, 0, 0 },       { 0, 0, 0 },
    { 0, 0, 0 },       { 0, 0, 0 },       { 0, 0, 0 },       { 0, 0, 0 },
};

/**
 * Compute palette color index from RGB values
 * 
 * This function maps RGB values to the closest color index in the V4P palette.
 * The palette uses 6 levels for each color channel (0, 51, 102, 153, 204, 255).
 * 
 * @param r Red component (0-255)
 * @param g Green component (0-255)
 * @param b Blue component (0-255)
 * @return Color index (0-255) in the V4P palette
 */
V4pColor v4p_rgb_to_palette_index(UInt8 r, UInt8 g, UInt8 b) {
    // Quantize each color channel to 6 levels (0, 51, 102, 153, 204, 255)
    UInt8 r_index = ((r + 25) / 51);
    UInt8 g_index = ((g + 25) / 51);
    UInt8 b_index = ((b + 25) / 51);

    // level indexes to compute palette index
    int bi[] = { 120, 114, 108, 12, 6, 0 };
    int ri[] = { 90, 72, 54, 36, 18, 0 };
    int gi[] = { 5, 4, 3 , 2, 1, 0 };
    
    return (V4pColor) (ri[r_index] + bi[b_index] + gi[g_index]);
}
